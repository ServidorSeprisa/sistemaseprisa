{% extends 'contacts/menuprueba3.html' %}  

{% load static %}

{% block content %}
{% comment %} <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <title>Tabla de Muestras</title> {% endcomment %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% comment %} </head> {% endcomment %}
<style>
    html, body {
        height: 100%;
        margin: 0;
        {% comment %} background-color: black; /* Aplica el fondo negro a toda la vista */ {% endcomment %}
        background-image: url("{% static 'images/fondo1.jpg' %}"); /* Cambia la ruta a tu imagen */

    }
    
    .container {
        background-color: rgb(0, 255, 255,0.8); /* Esto se puede dejar o eliminar */
        padding: 20px; /* Ajusta el padding según sea necesario */
        border-radius: 5px; /* Opcional, para un aspecto más estilizado */
    }
    .table {
        background-color:rgb(135, 206, 250,0.8)        ;
    }
    
</style>
{% comment %} <body> {% endcomment %}

<div class="d-flex justify-content-between mb-3">
    <form action="{% url 'buscar_orden_produccion' %}" method="get" style="max-width: 450px;">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Buscar por orden de producción" name="q" value="{{ request.GET.q }}">
            <button class="btn btn-primary">Buscar</button>
        </div>
    </form>
    <div>
        <a href="{% url 'orden_produccion2' %}" class="btn btn-outline-primary">Siguiente</a>
        <a href="{% url 'export_control_aseguramiento_pdf' %}" class="btn btn-outline-primary">Descargar Control de Aseguramiento</a>
        <a href="{% url 'export_control_aseguramiento_pdf2' %}" class="btn btn-outline-primary">Descargar Grafica</a>

    </div>
</div>

    <div class="container mt-5">
        <h2>Tabla de Muestras y Pesos</h2>
        <table class="table table-bordered" id="tablaMuestras">
            <thead>
                <tr>
                    <th>Muestra</th>
                    <th>Muestra 1</th>
                    <th>Muestra 2</th>
                    <th>Muestra 3</th>
                    <th>Muestra 4</th>
                    <th>Muestra 5</th>
                    <th>Muestra 6</th>
                    <th>Muestra 7</th>
                    <th>Muestra 8</th>
                    <th>Muestra 9</th>
                    <th>Muestra 10</th>
                    <th>Muestra 11</th>
                    <th>Muestra 12</th>
                    <th>Muestra 13</th>
                </tr>
            </thead>
            <tbody>
                <!-- Ejemplo de filas para las muestras -->
                <tr>
                    <td>1</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
                <!-- ... Repite para otras muestras ... -->
                <tr>
                    <td>2</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
                <tr>
                    <td>3</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
                <tr>
                    <td>4</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
                <tr>
                    <td>5</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
                <tr>
                    <td>6</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
                <tr>
                    <td>7</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
                <tr>
                    <td>8</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
                <tr>
                    <td>9</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
                <tr>
                    <td>10</td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                    <td><input type="number" class="form-control" /></td>
                </tr>
            </tbody>
        </table>
        <button class="btn btn-primary" onclick="calcularPromedios()">Calcular Promedios</button>

        <h3 class="mt-4">Gráfica de Promedios</h3>
        <canvas id="graficaPromedios" width="400" height="200"></canvas>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Este script asegura que todos los elementos con la clase .dropdown-toggle (que se usan para abrir los menús desplegables) se inicialicen correctamente.
        // el menu sin esto no funcionaba
        $(document).ready(function () {
            // Inicializar el menú desplegable
            $('.dropdown-toggle').dropdown();
        });
        let grafica;

        function calcularPromedios() {
        const filas = document.querySelectorAll('#tablaMuestras tbody tr');
        const numMuestras = filas[0].children.length - 1; // Total de muestras
        const sumas = new Array(numMuestras).fill(0);
        const counts = new Array(numMuestras).fill(0);

        filas.forEach(fila => {
            for (let i = 1; i <= numMuestras; i++) {
                const input = fila.children[i].querySelector('input');
                
                // Verifica si el input existe y tiene un valor válido
                if (input) {
                    const valor = parseFloat(input.value) || 0;
                    sumas[i - 1] += valor;
                    if (valor !== 0) counts[i - 1]++;
                }
            }
        });

        const promedios = sumas.map((suma, i) => (counts[i] > 0 ? (suma / counts[i]).toFixed(2) : 0));

        // Limpiar la gráfica anterior
        if (grafica) {
            grafica.destroy();
        }

        // Crear nueva gráfica
        const ctx = document.getElementById('graficaPromedios').getContext('2d');
        grafica = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({ length: numMuestras }, (_, i) => `Muestra ${i + 1}`),
                datasets: [{
                    label: 'Promedios',
                    data: promedios,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 1,
                    fill: true
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Añadir la fila de promedios a la tabla
        const tabla = document.querySelector('#tablaMuestras tbody');
        const filasPromedios = tabla.querySelectorAll('.fila-promedio');
        filasPromedios.forEach(fila => fila.remove());

        const promedioRow = document.createElement('tr');
        promedioRow.classList.add('fila-promedio');
        promedioRow.innerHTML = `<td>Promedio</td>${promedios.map(promedio => `<td>${promedio}</td>`).join('')}`;
        tabla.appendChild(promedioRow);
    }

    </script>

    <!-- Botón para descargar la gráfica como imagen PNG -->
<a href="#" id="descargarGrafica" class="btn btn-outline-primary">Descargar Gráfica</a>

<!-- Botón para descargar la tabla como archivo CSV -->
<a href="#" id="descargarTabla" class="btn btn-outline-primary">Descargar Tabla</a>

<script>
    // Función para descargar la gráfica como PNG
    document.getElementById('descargarGrafica').addEventListener('click', function() {
        const canvas = document.getElementById('graficaPromedios');
        const url = canvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = url;
        a.download = 'grafica_promedios.png';
        a.click();
    });

    // Función para descargar la tabla como archivo CSV
    document.getElementById('descargarTabla').addEventListener('click', function() {
        const filas = document.querySelectorAll('#tablaMuestras tbody tr');
        let csvContent = 'Muestra,' + Array.from(filas[0].children).slice(1).map((_, index) => `Muestra ${index + 1}`).join(',') + '\n';
        
        filas.forEach(fila => {
            const celdas = Array.from(fila.children).slice(0, -1);
            csvContent += celdas.map(celda => celda.querySelector('input')?.value || '').join(',') + '\n';
        });

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'tabla_muestras.csv';
        a.click();
    });
</script>

{% comment %} </body>
</html> {% endcomment %}
{% endblock content %}


